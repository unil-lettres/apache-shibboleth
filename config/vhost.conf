# https://shibboleth.atlassian.net/wiki/spaces/SHIB2/pages/2577072242/SPReverseProxy

<VirtualHost *:80>
    ServerName __SERVER_NAME__
    UseCanonicalName On

    # Reverse proxy configuration
    ProxyRequests Off
    ProxyPreserveHost On

    # Exclude Shibboleth handler from proxying (handles SAML protocol locally)
    ProxyPass /Shibboleth.sso !

    # Include custom configuration (REQUIRED)
    # Define your proxy configuration here: ProxyPass, DocumentRoot, FilesMatch, etc.
    # Mount your custom config to /etc/apache2/vhost.d/ or use APACHE_CUSTOM_CONFIG env var
    IncludeOptional /etc/apache2/vhost.d/*.conf

    # Forward Shibboleth attributes as HTTP headers to backend
    # Required for backends without access to Apache environment variables (microservices, containers, etc.)
    # Backends can read these attributes via HTTP headers (e.g., req.headers['x-shib-mail'])
    RequestHeader set X-Shib-Identity-Provider %{Shib-Identity-Provider}e env=Shib-Identity-Provider
    RequestHeader set X-Shib-eppn %{eppn}e env=eppn
    RequestHeader set X-Shib-mail %{mail}e env=mail
    RequestHeader set X-Shib-displayName %{displayName}e env=displayName
    RequestHeader set X-Shib-givenName %{givenName}e env=givenName
    RequestHeader set X-Shib-sn %{sn}e env=sn

    # Shibboleth protected paths (dynamically generated by entrypoint.sh)
    # You can protect one or multiple paths: /aai, /admin, /secure, or even / for the entire site
__SHIB_PROTECTED_PATHS_BLOCK__

    # Error logs
    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>
